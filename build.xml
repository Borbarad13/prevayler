<?xml version="1.0" encoding="UTF-8"?>

<project name="Prevayler" default="compile.core" basedir=".">

    <property file="${user.home}/.${ant.project.name}-build.properties"/>
    <property file="${user.home}/.build.properties"/>
    <property environment="env"/> <!-- provides access to system environment variables -->
    <property file="build.properties"/>


<!-- ==================== File and Directory Names ======================== -->

    <property name="build.home"             location="${basedir}/build" />
    <property name="dist.home"              location="${basedir}/dist" />
    <property name="doc.home"               location="${basedir}/docs" />
    <property name="lib.home"               location="${basedir}/lib" />
    <property name="dependencies.home"      location="${dependencies.path}" />
    <property name="src.home"               location="${basedir}/src" />
    <property name="src.core.home"          location="${src.home}/main" />
    <property name="src.test.home"          location="${src.home}/test" />
    <property name="src.package.path"       value="org/prevayler" />
    <property name="src.packages"           value="org.prevayler.*" />
    <property name="src.packages.excludes"  value="org.prevayler.demos.*, org.prevayler.test.*" />


<!--  ==================== Compilation Control Options ==================== -->

    <property name="build.debug"        value="on" />
    <property name="build.deprecation"  value="off" />
    <property name="build.optimize"     value="on" />
    <property name="build.verbose"      value="off" />

<!-- ==================== Compilation Classpath =========================== -->

    <path id="build.classpath" >
        <pathelement location="${commons-jxpath.jar}"/>
    </path>

    <path id="build.test.classpath" >
        <pathelement location="${build.home}" />
        <path refid="build.classpath" />
    </path>

<!-- ==================== Rebuild Target ====================================== -->

  <target name="rebuild" depends="clean, compile"
          description="Clean build and dist directories, then compile" />

<!-- ==================== Clean Targets ==================================== -->

    <target
        name="clean.all"
        depends="clean, clean.dependencies, clean.cache"
        description="Clean up everything including log and snapshot files generated by demos" />

    <target name="clean"
            description="Delete old build and dist directories" >

        <delete dir="${build.home}" />
        <delete dir="${dist.home}" />
        <delete dir="${lib.home}" />
        <delete dir="${doc.home}/api" />

    </target>

    <target name="clean.dependencies"
            description="Removes downloaded library dependencies" >

        <delete dir="${dependencies.home}" />

    </target>

    <target name="clean.cache"
            depends="clean.cache.tests, clean.cache.demos"
            description="Removes log and snapshot files generated by tests and demos" />

    <target name="clean.cache.tests"
            description="Removes log and snapshot files generated by tests" >

        <delete includeEmptyDirs="true">
            <fileset dir="${basedir}" >
                <include name="PrevalenceBase**/**" />
                <include name="**Test/**" />
                <include name="ScalabilityTest.properties" />
            </fileset>
        </delete>

    </target>

    <target name="clean.cache.demos"
            description="Removes log and snapshot files generated by demos" >

        <delete includeEmptyDirs="true">
            <fileset dir="${basedir}" >
                <include name="demo**/**" />
                <include name="PrevalenceBase/**" />
            </fileset>
        </delete>

    </target>

<!-- ==================== Prepare Target ================================== -->

    <target name="prepare" >

        <mkdir  dir="${build.home}" />
        <tstamp/>

    </target>

<!-- ==================== Compile Targets ================================== -->

    <target name="compile" depends="compile.core, compile.test, compile.contrib" description="Compile Java sources" />
    <target name="compile.core" depends="prepare" description="Compile Java core sources" >
        <antcall target="-compile.sub">
            <param name="srcdir" value="${src.core.home}" />
            <param name="includes" value="**/*.java" />
            <param name="excludes" value="**/old**/**,**/test/**" />
        </antcall>
    </target>
    <target name="compile.test" depends="compile.core" description="Compile Java test case sources" >
        <antcall target="-compile.sub">
            <param name="srcdir" value="${src.test.home}" />
            <param name="includes" value="**/test/**/*.java" />
            <param name="excludes" value="**/old**/**" />
        </antcall>
    </target>
    <target name="compile.contrib" depends="download,compile.core" description="Compile Java contrib sources" >
        <antcall target="-compile.sub">
            <param name="srcdir" value="${src.contrib.projects}" />
            <param name="includes" value="**/*.java" />
            <param name="excludes" value="**/old**/**" />
        </antcall>
    </target>

    <target name="-compile.sub" if="srcdir" >

        <!-- Compile Java classes as necessary -->
        <javac
            srcdir="${srcdir}"
            destdir="${build.home}"
            includes="${includes}"
            excludes="${excludes}"
            debug="${build.debug}"
            deprecation="${build.deprecation}"
            optimize="${build.optimize}"
            verbose="${build.verbose}">
            <classpath refid="build.classpath" />
        </javac>

        <!-- Copy application resources -->
        <!--<copy todir="${build.home}" >
            <fileset
                dir="${srcdir}"
                excludes="${excludes}"
                includes="**/*.properties,
                          **/*.character-sets,
                          **/*.dtd,
                          **/*.xml" />
        </copy>-->

    </target>

<!-- ==================== Dist Target ===================================== -->

    <target name="dist" depends="jar,javadoc"
            description="Create binary distribution" >

        <delete dir="${dependencies.home}" />

        <!-- Generate ZIP distribution -->
        <zip destfile="${dist.home}/${zip.name.dist}">
            <zipfileset dir="${basedir}"        prefix="${app.name}" includes="*.xml, *.properties"/>
            <zipfileset dir="${doc.home}"       prefix="${app.name}/docs"/>
            <zipfileset dir="${lib.home}"       prefix="${app.name}/lib"/>
            <zipfileset dir="${src.home}"       prefix="${app.name}/src" includes="**/*.java"/>
        </zip>

    </target>

<!-- ==================== Javadoc Target ================================== -->

    <target name="javadoc" depends="compile.core"
            description="Create Javadoc API documentation" >

        <mkdir dir="${doc.home}/api" />

        <condition property="javadoc.breakiterator" value="-breakiterator" >
            <or>
                <equals arg1="${ant.java.version}" arg2="1.4" />
                <equals arg1="${ant.java.version}" arg2="1.5" />
            </or>
        </condition>
        <property name="javadoc.breakiterator" value="" />

        <condition property="javadoc.jdk.href" value="http://java.sun.com/products/jdk/1.2/docs/api/">
            <equals arg1="${ant.java.version}" arg2="1.2" />
        </condition>
        <condition property="javadoc.jdk.href" value="http://java.sun.com/j2se/1.3/docs/api/">
            <equals arg1="${ant.java.version}" arg2="1.3" />
        </condition>
        <condition property="javadoc.jdk.href" value="http://java.sun.com/j2se/1.4/docs/api/">
            <equals arg1="${ant.java.version}" arg2="1.4" />
        </condition>
        <condition property="javadoc.jdk.href" value="http://java.sun.com/j2se/1.5/docs/api/">
            <equals arg1="${ant.java.version}" arg2="1.5" />
        </condition>
        <property name="javadoc.jdk.href" value="" />

        <property name="javadoc.jdk.offline" value="false" />
        <property name="javadoc.jdk.packaglistLoc" value="" />

        <javadoc
            sourcepath="${src.core.home}"
            packagenames="${src.packages}"
            excludepackagenames="${src.packages.excludes}"
            destdir="${doc.home}/api"
            author="true"
            version="true"
            use="true"
            additionalparam="${javadoc.breakiterator}"
            windowtitle="${app.name}&#8482; v${app.version} API Documentation" >

            <!-- <packageset...> below only works with Ant 1.5+.
                 We can use <packageset...> and remove "packagenames", "excludepackagenames",
                 and "sourcepath" attributes of the javadoc task -->
            <!--<packageset dir="${src.core.home}" defaultexcludes="yes" >
                <include name="${src.package.path}/**" />
            </packageset>-->

            <header><![CDATA[<a href="${app.url}" target="_blank">${app.name} Online</a>]]></header>
            <doctitle><![CDATA[<h1>${app.Name}</h1>]]></doctitle>
            <footer><![CDATA[<a href="${app.url}" target="_blank">${app.name} Online</a>]]></footer>
            <bottom><![CDATA[<i>${app.trademark}<br>Copyright &#169; ${app.year} ${app.company} All Rights Reserved.</i>]]></bottom>
            <link offline="${javadoc.jdk.offline}" href="${javadoc.jdk.href}" packagelistLoc="${javadoc.jdk.packagelistLoc}" />
            <classpath refid="build.test.classpath" />
        </javadoc>

    </target>

<!-- ==================== Jar Targets ================================== -->

    <target name="jar" depends="jar.core, jar.full"
            description="Creates all jars" />

    <target name="jar.init" >

        <mkdir dir="${lib.home}" />
        <mkdir dir="${dist.home}" />

    </target>

    <target name="jar.core" depends="compile.core, jar.init"
            description="Creates a JAR containing only essential Prevayler files" >

        <jar jarfile="${lib.home}/${jar.name.core}"
             basedir="${build.home}"
             excludes="**/demo/**,
                      **/demos/**,
                      **/test/**" />

    </target>

    <target name="jar.full" depends="compile, jar.init"
            description="Creates a JAR containing all compiled files" >

        <jar jarfile="${lib.home}/${jar.name.full}"
             basedir="${build.home}" />

    </target>

<!-- ==================== Test Targets ================================== -->

    <target name="run.test.functional" depends="compile.test"
            description="Runs the functional tests used to test Prevayler during development" >

        <java fork="true" classname="org.prevayler.test.Main" >
            <classpath refid="build.test.classpath" />
        </java>

    </target>

    <target name="run.test.scalability" depends="compile.test"
            description="Runs manipulation and query scalability tests against Prevayler and any JDBC database" >

        <java fork="true" classname="org.prevayler.test.scalability.Main" >
            <classpath refid="build.test.classpath" />
        </java>

    </target>

<!-- ==================== Demo Targets ================================== -->

<!--
    <target name="run.demo.prime" depends="compile.core"
            description="Runs simple prime number demonstration" >

        <java fork="false" classname="org.prevayler.demos.demo1.Main" >
            <classpath refid="build.test.classpath" />
        </java>

    </target>
-->

    <target name="run.demo.bank" depends="compile.core"
            description="Runs simple bank demonstration" >

        <java fork="true" classname="org.prevayler.demos.demo2.Main" >
            <classpath refid="build.test.classpath" />
        </java>

    </target>

    <target name="run.demo.bank.transient" depends="compile.core"
            description="Runs transient bank demonstration" >

        <java fork="true" classname="org.prevayler.demos.demo2.MainTransient" >
            <classpath refid="build.test.classpath" />
        </java>

    </target>

    <target name="run.demo.bank.rollback" depends="compile.core"
            description="Runs rollback bank demonstration" >

        <java fork="true" classname="org.prevayler.demos.demo2.MainRollback" >
            <classpath refid="build.test.classpath" />
        </java>

    </target>

    <target name="run.demo.bank.replica" depends="compile.core"
            description="Runs replica bank demonstration" >

        <parallel>
            <java fork="true" classname="org.prevayler.demos.demo2.MainReplicaServer" >
                <classpath refid="build.test.classpath" />
            </java>
            <sequential>
                <sleep seconds="3"/>
                <java fork="true" classname="org.prevayler.demos.demo2.MainReplica" >
                    <arg value="localhost" />
                    <classpath refid="build.test.classpath" />
                </java>
            </sequential>
        </parallel>

    </target>

    <target name="run.demo.bank.memento" depends="compile.contrib"
            description="Runs memento bank demonstration" >

        <java fork="true" classname="org.prevayler.demos.memento.TestErrorRecoveryWithMementos" >
            <classpath refid="build.test.classpath" />
        </java>

    </target>
    
<!-- ==================== Dependency Targets ================================== -->
    
    <target name="download" depends="-proxyflags" description="Download binary packages" >
        <mkdir dir="${dependencies.home}" />
        <!-- Downdown any sub package or tools needed. -->
        <antcall target="-downloadgz">
            <param name="sourcefile" value="${commons-jxpath.loc}"/>
            <param name="destfile" value="${commons-jxpath.jar}"/>
        </antcall>
    </target>

    <target name="-proxyflags">
        <!-- check proxy parameters. -->
        <condition property="useproxy">
            <equals arg1="${proxy.use}" arg2="on" />
        </condition>
    </target>

    <target name="-setproxy" if="useproxy">       
        <setproxy proxyhost="${proxy.host}" proxyport="${proxy.port}"/> 
        <echo message="Using ${proxy.host}:${proxy.port} to download ${sourcefile}"/>
    </target>

    <target name="-testexist">
        <echo message="Testing  for ${destfile}"/>
        <available file="${destfile}" property="exist"/>
    </target>

    <target name="-downloadgz" unless="exist" depends="-testexist">
        <!-- Download and extract the package -->
        <get src="${sourcefile}" dest="${dependencies.home}/file.tar.gz" />
        <gunzip src="${dependencies.home}/file.tar.gz" dest="${dependencies.home}/file.tar"/>
        <untar src="${dependencies.home}/file.tar" dest="${dependencies.home}"/>
        <delete file="${dependencies.home}/file.tar"/>
        <delete file="${dependencies.home}/file.tar.gz"/>
    </target>

</project>
